<?php
// Enable thumbnails
add_theme_support( 'post-thumbnails' );
set_post_thumbnail_size(200, 200, true); // Normal post thumbnails


// Custom CSS for the login page
// Create wp-login.css in your theme folder
function wpfme_loginCSS() {
  echo '<link rel="stylesheet" type="text/css" href="'.get_bloginfo('template_directory').'/wp-login.css"/>';
}
add_action('login_head', 'wpfme_loginCSS');


// Enable widgetable sidebar
// You may need to tweak your theme files, more info here - http://codex.wordpress.org/Widgetizing_Themes
if ( function_exists('register_sidebar') )
  register_sidebar(array(
    'before_widget' => '<aside>',
    'after_widget' => '</aside>',
    'before_title' => '<h1>',
    'after_title' => '</h1>',
  ));


// Remove the admin bar from the front end
add_filter( 'show_admin_bar', '__return_false' );


// Set a maximum width for Oembedded objects
if ( ! isset( $content_width ) )
  $content_width = 660;


// Add default posts and comments RSS feed links to head
add_theme_support( 'automatic-feed-links' );


// Put post thumbnails into rss feed
function wpfme_feed_post_thumbnail($content) {
  global $post;
  if(has_post_thumbnail($post->ID)) {
    $content = ''.get_the_post_thumbnail($post->ID).'' . $content;
  }
  return $content;
}
add_filter('the_excerpt_rss', 'wpfme_feed_post_thumbnail');
add_filter('the_content_feed', 'wpfme_feed_post_thumbnail');


// Add custom menus
register_nav_menus( array(
  'primary' => __( 'Primary Navigation', 'wpfme' ),
  //'example' => __( 'Example Navigation', 'wpfme' ),
) );


// Enable admin to set custom background images in 'appearance > background'
add_custom_background();


// Randomly chosen placeholder text for post/page edit screen
function wpfme_writing_encouragement( $content ) {
  global $post_type;
  if($post_type == "post"){
    $encArray = array(
      // Placeholders for the posts editor
      "Test post message one.",
      "Test post message two.",
      "<h1>Test post heading!</h1>"
    );
    return $encArray[array_rand($encArray)];
  }
  else{ $encArray = array(
    // Placeholders for the pages editor
    "Test page message one.",
    "Test page message two.",
    "<h1>Test Page Heading</h1>"
  );
  return $encArray[array_rand($encArray)];
  }
}
add_filter( 'default_content', 'wpfme_writing_encouragement' );


//change amount of posts on the search page - set here to 100
function wpfme_search_results_per_page( $query ) {
  global $wp_the_query;
  if ( ( ! is_admin() ) && ( $query === $wp_the_query ) && ( $query->is_search() ) ) {
    $query->set( 'wpfme_search_results_per_page', 100 );
  }
  return $query;
}
add_action( 'pre_get_posts',  'wpfme_search_results_per_page'  );


//create a permalink after the excerpt
function wpfme_replace_excerpt($content) {
  return str_replace('[...]',
    '<a class="readmore" href="'. get_permalink() .'">Continue Reading</a>',
    $content
  );
}
add_filter('the_excerpt', 'wpfme_replace_excerpt');


// Create custom sizes
// This is then pulled through to your theme useing the_post_thumbnail('custombig');
if ( function_exists( 'add_image_size' ) ) {
  add_image_size('customsmall', 300, 200, true); //narrow column
  add_image_size('custombig', 400, 500, true); //wide column
}


// Stop images getting wrapped up in p tags when they get dumped out with the_content() for easier theme styling
function wpfme_remove_img_ptags($content){
  return preg_replace('/<p>\s*(<a .*>)?\s*(<img .* \/>)\s*(\/a>)?\s*<\/p>/iU', '\1\2\3', $content);
}
add_filter('the_content', 'wpfme_remove_img_ptags');


// Call the google CDN version of jQuery for the frontend
// Make sure you use this with wp_enqueue_script('jquery'); in your header
function wpfme_jquery_enqueue() {
  wp_deregister_script('jquery');
  wp_register_script('jquery', "http" . ($_SERVER['SERVER_PORT'] == 443 ? "s" : "") . "://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js", false, null);
  wp_enqueue_script('jquery');
}
if (!is_admin()) add_action("wp_enqueue_scripts", "wpfme_jquery_enqueue", 11);


//custom excerpt length
function wpfme_custom_excerpt_length( $length ) {
  //the amount of words to return
  return 20;
}
add_filter( 'excerpt_length', 'wpfme_custom_excerpt_length');


// Remove the version number of WP
// Warning - this info is also available in the readme.html file in your root directory - delete this file!
remove_action('wp_head', 'wp_generator');


// Obscure login screen error messages
function wpfme_login_obscure(){ return '<strong>Sorry</strong>: Think you have gone wrong somwhere!';}
add_filter( 'login_errors', 'wpfme_login_obscure' );

?>
